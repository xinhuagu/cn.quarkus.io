<!DOCTYPE html>
<html>





<head>
  <title>编写原生应用程序的提示 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/guides/writing-native-applications-tips" />
  <meta property="og:title" content="编写原生应用程序的提示" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/writing-native-applications-tips">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  

<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">关于<i class="fas fa-chevron-down">
</i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUS是什么？</a></li>
          <li><a href="/container-first" class="">容器优先 </a></li>
          <li><a href="/continuum" class="">响应式</a></li>
          <li><a href="/developer-joy" class="">开发者的乐趣 </a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES 原生</a></li>
          <li><a href="/standards" class="">标准</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学习 <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入门</a></li>
          <li><a href="/guides" class="active" >指南</a></li>
          <li><a href="/qtips" class="">"Q" TIP视频</a></li>          
          <li><a href="/books" class="">书籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">社区 <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">支持</a></li>
          <li><a href="/blog" class="" >博客</a></li>
          <li><a href="/discussion" class="">讨论</a></li>
          <li><a href="/insights" class="" >播客</a></li>
          <li><a href="/events" class="">活动</a></li>
          <li><a href="/newsletter" class="">新闻</a></li>
          <li><a href="/publications" class="">发表</a></li>
          <li><a href="/awards" class="">获奖</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">开始写代码</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://es.quarkus.io/">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/">日本語</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/guides/">返回指南目录</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">选择指南版本</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" selected>2.11 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" >1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">编写原生应用程序的提示 </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#在你的应用程序中支持原生">在你的应用程序中支持原生</a>
<ul class="sectlevel2">
<li><a href="#包含资源">包含资源</a></li>
<li><a href="#注册反射">注册反射</a></li>
<li><a href="#推迟类的初始化">推迟类的初始化</a></li>
<li><a href="#管理代理类">管理代理类</a></li>
</ul>
</li>
<li><a href="#native-in-extension">在Quarkus扩展中支持原生</a>
<ul class="sectlevel2">
<li><a href="#注册反射-2">注册反射</a></li>
<li><a href="#包含资源-2">包含资源</a></li>
</ul>
</li>
<li><a href="#推迟类的初始化-2">推迟类的初始化</a>
<ul class="sectlevel2">
<li><a href="#管理代理类-2">管理代理类</a></li>
<li><a href="#使用原生镜像日志">使用原生镜像日志</a></li>
</ul>
</li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>本指南包含各种提示和技巧，以解决在尝试以本地可执行文件形式运行Java应用程序时可能出现的问题。</p>
</div>
<div class="paragraph">
<p>请注意，我们区分了两种情况，适用的解决方案可能是不同的：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在应用程序里面，你将通过 <code>pom.xml</code> 来调整 <code>native-image</code> 的配置</p>
</li>
<li>
<p>在扩展里面，Quarkus提供了很多基础设施来简化这一切</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>请根据你的情况，参考适当的章节。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="在你的应用程序中支持原生"><a class="anchor" href="#在你的应用程序中支持原生"></a>在你的应用程序中支持原生</h2>
<div class="sectionbody">
<div class="paragraph">
<p>由于GraalVM的一些限制，在构建生成本地可执行文件的时候，可能需要进行一些调整。</p>
</div>
<div class="sect2">
<h3 id="包含资源"><a class="anchor" href="#包含资源"></a>包含资源</h3>
<div class="paragraph">
<p>默认情况下，在构建本地可执行文件时，GraalVM不会将classpath上的任何资源纳入其创建的本地可执行文件。要成为本地可执行文件一部分的资源，需要明确地进行配置。</p>
</div>
<div class="paragraph">
<p>Quarkus automatically includes the resources present in <code>META-INF/resources</code> (the web resources) but, outside this directory, you are on your own.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>请注意，你在这里需要非常小心，因为 <code>META-INF/resources</code> 中的任何东西都会作为静态网络资源暴露出来。所以这个目录不是 "让我们自动把这些资源包含在本地可执行文件中 "的捷径，而应该只用于静态网络资源。</p>
</div>
<div class="paragraph">
<p>其他资源应明确声明。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>要在本地可执行文件中包含更多的资源，最简单的方法是使用 <code>quarkus.native.resources.includes</code> 配置属性，及其对应的排除资源 <code>quarkus.native.resources.excludes</code>。</p>
</div>
<div class="paragraph">
<p>这两个配置属性都支持glob模式。</p>
</div>
<div class="paragraph">
<p>例如，在你的 <code>application.properties</code> 中有以下属性：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.resources.includes=foo/**,bar/**/*.txt
quarkus.native.resources.excludes=foo/private/**</code></pre>
</div>
</div>
<div class="paragraph">
<p>将包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>foo/</code> 目录及其子目录中的所有文件，但 <code>foo/private/</code> 及其子目录中的文件除外</p>
</li>
<li>
<p><code>bar/</code> 目录及其子目录下的所有文本文件</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If globs are not sufficiently precise for your use case and you need to rely on regular expressions, or if you prefer relying on the GraalVM infrastructure, you can also create a <code>resources-config.json</code> (the most common location is within <code>src/main/resources</code>) JSON file defining which resources should be included:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "resources": [
    {
      "pattern": ".*\\.xml$"
    },
    {
      "pattern": ".*\\.json$"
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这些模式都是有效的Java正则表达式。在这里，我们将所有的XML文件和JSON文件纳入本地可执行文件。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>你可以在 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/Resources.md">GraalVM文档</a>中找到更多关于这个主题的信息。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>最后一项工作是通过向 <code>application.properties</code> 添加适当的配置，使配置文件为 <code>native-image</code> 可执行文件所知：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.additional-build-args =-H:ResourceConfigurationFiles=resources-config.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>在前面的片段中，我们能够简单地使用 <code>resources-config.json</code> ，而不是指定文件的整个路径，只是因为它被添加到了 <code>src/main/resources</code> 。如果该文件被添加到了另一个目录，就必须手动指定适当的文件路径。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>多个选项可以用逗号隔开。例如，可以使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.additional-build-args =\
    -H:ResourceConfigurationFiles=resources-config.json,\
    -H:ReflectionConfigurationFiles=reflection-config.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>以确保各种资源被包括在内，并注册了额外的反射。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>如果由于某种原因，将上述配置添加到 <code>application.properties</code> ，是不可取的，可以通过配置构建工具来有效地执行相同的操作。</p>
</div>
<div class="paragraph">
<p>使用Maven时，我们可以使用以下配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;native&lt;/id&gt;
        &lt;properties&gt;
            &lt;quarkus.package.type&gt;native&lt;/quarkus.package.type&gt;
            &lt;quarkus.native.additional-build-args&gt;-H:ResourceConfigurationFiles=resources-config.json&lt;/quarkus.native.additional-build-args&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="注册反射"><a class="anchor" href="#注册反射"></a>注册反射</h3>
<div class="paragraph">
<p>在构建本地可执行文件时，GraalVM以封闭世界的假设进行操作。它分析调用树并删除所有不直接使用的类/方法/字段。</p>
</div>
<div class="paragraph">
<p>通过反射使用的元素不是调用树的一部分，所以它们是被消除的死代码（如果不是在其他情况下直接调用）。要在你的本地可执行文件中包含这些元素，你需要为反射明确地注册它们。</p>
</div>
<div class="paragraph">
<p>这是一个非常常见的情况，因为JSON库通常使用反射来将对象序列化为JSON：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public class Person {
        private String first;
        private String last;

        public String getFirst() {
            return first;
        }

        public void setFirst(String first) {
            this.first = first;
        }

        public String getLast() {
            return last;
        }

        public void setValue(String last) {
            this.last = last;
        }
    }

    @Path("/person")
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_JSON)
    public class PersonResource {

        private final Jsonb jsonb;

        public PersonResource() {
            jsonb = JsonbBuilder.create(new JsonbConfig());
        }

        @GET
        public Response list() {
            return Response.ok(jsonb.fromJson("{\"first\":  \"foo\", \"last\":  \"bar\"}", Person.class)).build();
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果我们使用上面的代码，在使用本地可执行文件时，我们会得到一个类似下面的异常：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Exception handling request to /person: org.jboss.resteasy.spi.UnhandledException: javax.json.bind.JsonbException: Can't create instance of a class: class org.acme.jsonb.Person, No default constructor found</code></pre>
</div>
</div>
<div class="paragraph">
<p>或如果你在使用Jackson：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">com.fasterxml.jackson.databind.exc.InvalidDefinitionException: No serializer found for class org.acme.jsonb.Person and no properties discovered to create BeanSerializer (to avoid exception, disable SerializationFeature.FAIL_ON_EMPTY_BEANS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>一个更糟糕的结果是没有抛出异常，而JSON的结果是完全空的。</p>
</div>
<div class="paragraph">
<p>有两种不同的方法来解决这种类型的问题。</p>
</div>
<div class="sect3">
<h4 id="registerForReflection"><a class="anchor" href="#registerForReflection"></a>使用@RegisterForReflection注解</h4>
<div class="paragraph">
<p>为反射注册一个类的最简单方法是使用 <code>@RegisterForReflection</code> 注解：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RegisterForReflection
public class MyClass {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你的类在第三方的jar中，你可以通过使用一个空的类来做，这个空的类将为它托管 <code>@RegisterForReflection</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RegisterForReflection(targets={ MyClassRequiringReflection.class, MySecondClassRequiringReflection.class})
public class MyReflectionConfiguration {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意， <code>MyClassRequiringReflection</code> 和 <code>MySecondClassRequiringReflection</code> 将被注册为反射，但不包括 <code>MyReflectionConfiguration</code> 。</p>
</div>
<div class="paragraph">
<p>在运用使用对象映射功能的第三方库（如Jackson或GSON）时，这个功能很方便：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RegisterForReflection(targets = {User.class, UserImpl.class})
public class MyReflectionConfiguration {

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="使用配置文件"><a class="anchor" href="#使用配置文件"></a>使用配置文件</h4>
<div class="paragraph">
<p>你可以使用配置文件来为反射注册类。</p>
</div>
<div class="paragraph">
<p>作为一个例子，为了注册类 <code>com.acme.MyClass</code> 的所有方法进行反射，我们创建 <code>reflection-config.json</code> （最常见的位置是在 <code>src/main/resources</code> 内）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "name" : "com.acme.MyClass",
    "allDeclaredConstructors" : true,
    "allPublicConstructors" : true,
    "allDeclaredMethods" : true,
    "allPublicMethods" : true,
    "allDeclaredFields" : true,
    "allPublicFields" : true
  }
]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>关于该文件格式的更多细节，请参考 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/Reflection.md">GraalVM文档</a> 。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>最后一项工作是通过向 <code>application.properties</code> 添加适当的配置，使配置文件为 <code>native-image</code> 可执行文件所知：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.additional-build-args =-H:ReflectionConfigurationFiles=reflection-config.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>在前面的片段中，我们能够简单地使用 <code>reflection-config.json</code> ，而不是指定文件的整个路径，只是因为它被添加到了 <code>src/main/resources</code> 。如果该文件被添加到了另一个目录，就必须手动指定适当的文件路径。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>多个选项可以用逗号隔开。例如，可以使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.additional-build-args =\
    -H:ResourceConfigurationFiles=resources-config.json,\
    -H:ReflectionConfigurationFiles=reflection-config.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>以确保各种资源被包括在内，并注册了额外的反射。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>如果由于某种原因，将上述配置添加到 <code>application.properties</code> ，是不可取的，可以通过配置构建工具来有效地执行相同的操作。</p>
</div>
<div class="paragraph">
<p>使用Maven时，我们可以使用以下配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;native&lt;/id&gt;
        &lt;properties&gt;
            &lt;quarkus.package.type&gt;native&lt;/quarkus.package.type&gt;
            &lt;quarkus.native.additional-build-args&gt;-H:ReflectionConfigurationFiles=reflection-config.json&lt;/quarkus.native.additional-build-args&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="推迟类的初始化"><a class="anchor" href="#推迟类的初始化"></a>推迟类的初始化</h3>
<div class="paragraph">
<p>默认情况下，Quarkus在构建时初始化所有类。</p>
</div>
<div class="paragraph">
<p>There are cases where the initialization of certain classes is done in a static block needs to be postponed to runtime. Typically, omitting such configuration would result in a runtime exception like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Error: No instances are allowed in the image heap for a class that is initialized or reinitialized at image runtime: sun.security.provider.NativePRNG
Trace: object java.security.SecureRandom
method com.amazonaws.services.s3.model.CryptoConfiguration.&lt;init&gt;(CryptoMode)
Call path from entry point to com.amazonaws.services.s3.model.CryptoConfiguration.&lt;init&gt;(CryptoMode):</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你需要推迟一个类的初始化，你可以使用 <code>--initialize-at-run-time=&lt;package or class&gt;</code> 来进行配置。</p>
</div>
<div class="paragraph">
<p>它应该使用 <code>quarkus.native.additional-build-args</code> 配置属性添加到 <code>native-image</code> 配置中，如上面的例子所示。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>你可以在 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/ClassInitialization.md">GraalVM的文档</a>中找到更多关于这一切的信息。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>当需要通过 <code>quarkus.native.additional-build-args</code> 配置属性指定多个类或包时，需要对 <code>,</code> 符号进行转义。这方面的一个例子如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.additional-build-args=--initialize-at-run-time=com.example.SomeClass\\,org.acme.SomeOtherClass</code></pre>
</div>
</div>
<div class="paragraph">
<p>以及在使用Maven配置而不是 <code>application.properties</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;quarkus.native.additional-build-args&gt;--initialize-at-run-time=com.example.SomeClass\,org.acme.SomeOtherClass&lt;/quarkus.native.additional-build-args&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="管理代理类"><a class="anchor" href="#管理代理类"></a>管理代理类</h3>
<div class="paragraph">
<p>在编写本地应用程序时，你需要在构建时通过指定它们的实现接口列表来定义代理类。</p>
</div>
<div class="paragraph">
<p>在这种情况下，你可能遇到的错误是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">com.oracle.svm.core.jdk.UnsupportedFeatureError: Proxy class defined by interfaces [interface org.apache.http.conn.HttpClientConnectionManager, interface org.apache.http.pool.ConnPoolControl, interface com.amazonaws.http.conn.Wrapped] not found. Generating proxy classes at runtime is not supported. Proxy classes need to be defined at image build time by specifying the list of interfaces that they implement. To define proxy classes use -H:DynamicProxyConfigurationFiles=&lt;comma-separated-config-files&gt; and -H:DynamicProxyConfigurationResources=&lt;comma-separated-config-resources&gt; options.</code></pre>
</div>
</div>
<div class="paragraph">
<p>解决这个问题需要添加 <code>-H:DynamicProxyConfigurationResources=&lt;comma-separated-config-resources&gt;</code> 参数，并提供一个动态代理配置文件。你可以在 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/DynamicProxy.md#manual-configuration">GraalVM文档</a>中找到关于这个文件格式的所有信息。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="native-in-extension"><a class="anchor" href="#native-in-extension"></a>在Quarkus扩展中支持原生</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在Quarkus扩展中支持本机更容易，因为Quarkus提供了很多工具来简化这一切。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>这里描述的一切只在Quarkus扩展的范围内起作用，在应用程序中不会起作用。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="注册反射-2"><a class="anchor" href="#注册反射-2"></a>注册反射</h3>
<div class="paragraph">
<p>Quarkus通过使用 <code>ReflectiveClassBuildItem</code> ，使得在扩展中注册反射变得轻而易举，从而消除了对JSON配置文件的需求。</p>
</div>
<div class="paragraph">
<p>要为反射注册一个类，需要创建一个Quarkus处理器类并添加一个注册反射的构建步骤：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SaxParserProcessor {

    @BuildStep
    ReflectiveClassBuildItem reflection() {
        // since we only need reflection to the constructor of the class, we can specify `false` for both the methods and the fields arguments.
        return new ReflectiveClassBuildItem(false, false, "com.sun.org.apache.xerces.internal.parsers.SAXParser");
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>关于GraalVM中反射的更多信息可以 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/Reflection.md">在这里</a> 找到。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="包含资源-2"><a class="anchor" href="#包含资源-2"></a>包含资源</h3>
<div class="paragraph">
<p>在扩展里面，Quarkus通过允许扩展的作者指定一个 <code>NativeImageResourceBuildItem</code> 来消除对JSON配置文件的需求：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ResourcesProcessor {

    @BuildStep
    NativeImageResourceBuildItem nativeImageResourceBuildItem() {
        return new NativeImageResourceBuildItem("META-INF/extra.properties");
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>关于本地可执行文件中GraalVM资源处理的更多信息，请参考 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/Resources.md">GraalVM文档</a> 。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="推迟类的初始化-2"><a class="anchor" href="#推迟类的初始化-2"></a>推迟类的初始化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus通过允许扩展作者简单地注册一个 <code>RuntimeInitializedClassBuildItem</code> 来简化操作。这样做的一个简单例子是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class S3Processor {

    @BuildStep
    RuntimeInitializedClassBuildItem cryptoConfiguration() {
        return new RuntimeInitializedClassBuildItem(CryptoConfiguration.class.getCanonicalName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用这样的结构意味着 <code>--initialize-at-run-time</code> 参数将被自动添加到 <code>native-image</code> 命令行中。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>关于 <code>--initialize-at-run-time</code> 的更多信息，请阅读 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/ClassInitialization.md">GraalVM文档</a> 。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="管理代理类-2"><a class="anchor" href="#管理代理类-2"></a>管理代理类</h3>
<div class="paragraph">
<p>非常相似的是，Quarkus允许扩展作者注册一个 <code>NativeImageProxyDefinitionBuildItem</code> 。这样做的一个例子是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class S3Processor {

    @BuildStep
    NativeImageProxyDefinitionBuildItem httpProxies() {
        return new NativeImageProxyDefinitionBuildItem("org.apache.http.conn.HttpClientConnectionManager",
                "org.apache.http.pool.ConnPoolControl", "com.amazonaws.http.conn.Wrapped");
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用这样的结构意味着 <code>-H:DynamicProxyConfigurationResources</code> 参数将被自动添加到 <code>native-image</code> 命令行中。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>关于代理类的更多信息，你可以阅读 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/DynamicProxy.md">GraalVM文档</a> 。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="使用原生镜像日志"><a class="anchor" href="#使用原生镜像日志"></a>使用原生镜像日志</h3>
<div class="paragraph">
<p>如果你的应用需要依赖日志组件（如Apache Commons logging或Log4j），并且在构建原生可执行文件时遇到了' ClassNotFoundException '，你可以通过排除日志库并添加相应的JBoss日志适配器来解决这个问题。</p>
</div>
<div class="paragraph">
<p>更多细节请参考 <a href="logging#logging-adapters">日志指南</a>。</p>
</div>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus是开放的。这个项目的所有依赖关系在<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>许可或者可以在有互换性的许可下使用。<br /><br />这个网站使用 <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> 来构建，代码托管于<a href='https://pages.github.com/' target='_blank'>Github Pages</a>，完全开源。当需要改善和丰富内容的时候，我们会从 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>网站项目</a>创建分支，然后修正并发布到网站。</p>

    
      <div class="width-1-12 project-links">
        <span>导航栏</span>
        <ul class="footer-links">
          
            <li><a href="/">主页</a></li>
          
            <li><a href="/about">关于Quarkus</a></li>
          
            <li><a href="/blog">博客</a></li>
          
            <li><a href="/insights">播客</a></li>
          
            <li><a href="/events">活动</a></li>
          
            <li><a href="/newsletter">新闻</a></li>
          
            <li><a href="/publications">发表</a></li>
          
            <li><a href="/awards">获奖</a></li>
          
            <li><a href="/security">安全</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>社交媒体</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>协助</span>
        <ul class="footer-links">
          
            <li><a href="/support">支持</a></li>
          
            <li><a href="/guides">指南</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入门</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">讨论</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">开发邮件列表</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://es.quarkus.io/">Español</a></li>
          
            <li><a href="https://ja.quarkus.io/">日本語</a></li>
          
            <li><a href="https://cn.quarkus.io/">简体中文</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus由社区项目组成：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">更多...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
